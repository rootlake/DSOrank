<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Three Winners - DSO Class Compare</title>
    <link href="./styles.css" rel="stylesheet">
    <script src="./imageLoader.js"></script>
    <script>
        // Student names mapping - will be loaded from JSON
        let studentNames = {};
        
        // Load student names
        async function loadStudentNames() {
            try {
                const response = await fetch('student-names.json');
                studentNames = await response.json();
            } catch (error) {
                console.warn('Could not load student-names.json, using initials only');
                studentNames = {};
            }
        }
        
        // Get student name from initials, fallback to initials if not found
        function getStudentName(objectName, initials) {
            if (studentNames[objectName] && studentNames[objectName][initials.toUpperCase()]) {
                const name = studentNames[objectName][initials.toUpperCase()];
                return name || initials.toUpperCase();
            }
            return initials.toUpperCase();
        }
        
        // Load names on page load
        loadStudentNames();
    </script>
</head>
<body>
    <div class="controls">
        <select id="objectSelect" onchange="onObjectChange()">
            <option value="M31">M31</option>
            <option value="M42">M42</option>
            <option value="M45">M45</option>
            <option value="M45_2026" selected>M45_2026</option>
        </select>
        <button id="toggleInput" onclick="toggleInputPanel()">Hide Input Panel</button>
        <button id="generateRandom" onclick="generateRandomRankings()">Generate Random Test Data</button>
        <button id="calculateWinners" onclick="calculateWinners()">Calculate Winners</button>
        <button id="toggleInitials" onclick="toggleInitials()" style="display: none;">Show Initials</button>
    </div>

    <div id="inputPanel" class="input-panel" style="display: block;">
        <h3>Enter Student Rankings (paste one per line)</h3>
        <textarea id="rankingsInput" placeholder="M45_2026,525,002,694,973,682,459,462,927,498,821,564,650&#10;M45_2026,002,525,694,973,682,459,462,927,498,821,564,650&#10;M45_2026,694,525,002,973,682,459,462,927,498,821,564,650&#10;..."></textarea>
        <div class="input-info">Format: object,number,number,... (one ranking per line). Paste all student submissions here.</div>
    </div>

    <div id="podiumContainer" class="podium-container">
        <div class="podium-placeholder">Select an object and calculate winners to see the podium</div>
    </div>

    <script>
        let currentObjectConfig = null;
        let topThreeWinners = [];
        let currentZoomIndex = -1;
        let showInitials = true;

        async function onObjectChange() {
            const selected = document.getElementById('objectSelect').value;
            try {
                currentObjectConfig = await window.imageLoader.loadObjectConfig(selected);
                // Clear podium when object changes
                document.getElementById('podiumContainer').innerHTML = '<div class="podium-placeholder">Select an object and calculate winners to see the podium</div>';
            } catch (error) {
                console.error(`Error loading ${selected}:`, error);
                alert(`Error loading ${selected}. Please check the console for details.`);
            }
        }

        function toggleInputPanel() {
            const panel = document.getElementById('inputPanel');
            const button = document.getElementById('toggleInput');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                button.textContent = 'Hide Input Panel';
            } else {
                panel.style.display = 'none';
                button.textContent = 'Show Input Panel';
            }
        }

        function generateRandomRankings() {
            if (!currentObjectConfig) {
                alert('Please select an object first');
                return;
            }

            const objectName = currentObjectConfig.objectName;
            const images = currentObjectConfig.images;
            const filenameNumbers = images.map(img => img.filenameNumber);
            
            // Generate 10 random rankings
            const rankings = [];
            for (let i = 0; i < 10; i++) {
                const shuffled = [...filenameNumbers];
                // Fisher-Yates shuffle
                for (let j = shuffled.length - 1; j > 0; j--) {
                    const k = Math.floor(Math.random() * (j + 1));
                    [shuffled[j], shuffled[k]] = [shuffled[k], shuffled[j]];
                }
                rankings.push(`${objectName},${shuffled.join(',')}`);
            }
            
            document.getElementById('rankingsInput').value = rankings.join('\n');
        }

        function parseRanking(rankingString) {
            const parts = rankingString.trim().split(',');
            if (parts.length < 2) {
                throw new Error('Invalid format: expected "object,number,number,..."');
            }
            
            const objectName = parts[0];
            const numbers = parts.slice(1);
            
            return { objectName, numbers };
        }

        function calculatePoints(rankings, objectName) {
            if (!currentObjectConfig || currentObjectConfig.objectName !== objectName) {
                throw new Error(`Object ${objectName} not loaded`);
            }

            const numImages = currentObjectConfig.images.length;
            const pointsMap = {}; // filenameNumber -> total points

            // Initialize points map
            currentObjectConfig.images.forEach(img => {
                pointsMap[img.filenameNumber] = 0;
            });

            // Process each ranking
            rankings.forEach(ranking => {
                const { numbers } = parseRanking(ranking);
                
                numbers.forEach((number, index) => {
                    const rank = index + 1; // 1st = 1, 2nd = 2, etc.
                    const points = numImages - rank + 1; // 1st = N points, last = 1 point
                    
                    if (pointsMap.hasOwnProperty(number)) {
                        pointsMap[number] += points;
                    }
                });
            });

            // Convert to array and sort by points
            const results = Object.entries(pointsMap).map(([filenameNumber, points]) => {
                const imageData = currentObjectConfig.images.find(img => img.filenameNumber === filenameNumber);
                return {
                    filenameNumber,
                    filename: imageData.filename,
                    points,
                    initials: imageData.initials
                };
            });

            results.sort((a, b) => b.points - a.points);
            return results;
        }

        function calculateWinners() {
            if (!currentObjectConfig) {
                alert('Please select an object first');
                return;
            }

            const input = document.getElementById('rankingsInput').value.trim();
            if (!input) {
                alert('Please enter rankings or generate random test data');
                return;
            }

            const lines = input.split('\n').filter(line => line.trim());
            if (lines.length === 0) {
                alert('No rankings found');
                return;
            }

            try {
                const objectName = currentObjectConfig.objectName;
                
                // Validate all rankings are for the same object
                const invalidLines = [];
                lines.forEach((line, index) => {
                    try {
                        const parsed = parseRanking(line);
                        if (parsed.objectName !== objectName) {
                            invalidLines.push(`Line ${index + 1}: wrong object (${parsed.objectName} vs ${objectName})`);
                        }
                    } catch (e) {
                        invalidLines.push(`Line ${index + 1}: ${e.message}`);
                    }
                });
                
                if (invalidLines.length > 0) {
                    alert(`Invalid rankings found:\n${invalidLines.join('\n')}`);
                    return;
                }
                
                const results = calculatePoints(lines, objectName);
                
                // Get top 3
                const topThree = results.slice(0, 3);
                
                console.log(`Processed ${lines.length} rankings`);
                console.log('Top 3:', topThree);
                
                // Store top three globally for zoom functionality
                topThreeWinners = topThree;
                allResultsCache = results;
                showInitials = true;
                
                // Show/hide initials button
                const toggleBtn = document.getElementById('toggleInitials');
                if (topThree.length > 0) {
                    toggleBtn.style.display = 'inline-block';
                    toggleBtn.textContent = 'Hide Initials';
                } else {
                    toggleBtn.style.display = 'none';
                }
                
                displayPodium(topThree, results);
            } catch (error) {
                alert(`Error calculating winners: ${error.message}`);
                console.error(error);
            }
        }

        function displayPodium(topThree, allResults) {
            const container = document.getElementById('podiumContainer');
            
            if (topThree.length < 3) {
                container.innerHTML = `<div class="podium-placeholder">Not enough images for podium (need at least 3)</div>`;
                return;
            }

            const [first, second, third] = topThree;
            const objectName = currentObjectConfig.objectName;
            const folder = currentObjectConfig.folder;

            container.innerHTML = `
                <div class="podium">
                    <div class="podium-place second" onclick="zoomToWinner(1)">
                        <div class="podium-image">
                            <img src="${folder}/${second.filename}" alt="2nd place">
                        </div>
                        <div class="podium-info">
                            <div class="podium-badge">2nd${showInitials ? ` <span class="podium-initials podium-silver">${getStudentName(objectName, second.initials)}</span>` : ''}</div>
                            <div class="podium-number">${second.filenameNumber}</div>
                            <div class="podium-points">${second.points} points</div>
                        </div>
                    </div>
                    <div class="podium-place first" onclick="zoomToWinner(0)">
                        <div class="podium-image">
                            <img src="${folder}/${first.filename}" alt="1st place">
                        </div>
                        <div class="podium-info">
                            <div class="podium-badge">1st${showInitials ? ` <span class="podium-initials podium-gold">${getStudentName(objectName, first.initials)}</span>` : ''}</div>
                            <div class="podium-number">${first.filenameNumber}</div>
                            <div class="podium-points">${first.points} points</div>
                        </div>
                    </div>
                    <div class="podium-place third" onclick="zoomToWinner(2)">
                        <div class="podium-image">
                            <img src="${folder}/${third.filename}" alt="3rd place">
                        </div>
                        <div class="podium-info">
                            <div class="podium-badge">3rd${showInitials ? ` <span class="podium-initials podium-bronze">${getStudentName(objectName, third.initials)}</span>` : ''}</div>
                            <div class="podium-number">${third.filenameNumber}</div>
                            <div class="podium-points">${third.points} points</div>
                        </div>
                    </div>
                </div>
                <div class="podium-summary">
                    <h3>Full Results</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Number</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allResults.map((result, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${result.filenameNumber}</td>
                                    <td>${result.points}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function toggleInitials() {
            showInitials = !showInitials;
            const btn = document.getElementById('toggleInitials');
            btn.textContent = showInitials ? 'Hide Initials' : 'Show Initials';
            
            // Re-render podium to show/hide initials
            if (topThreeWinners.length > 0) {
                const container = document.getElementById('podiumContainer');
                const summary = container.querySelector('.podium-summary');
                const allResults = Array.from(container.querySelectorAll('.podium-summary tbody tr')).map((row, idx) => {
                    const cells = row.querySelectorAll('td');
                    return {
                        filenameNumber: cells[1].textContent,
                        points: parseInt(cells[2].textContent),
                        initials: topThreeWinners.find(w => w.filenameNumber === cells[1].textContent)?.initials || 
                                 currentObjectConfig.images.find(img => img.filenameNumber === cells[1].textContent)?.initials || ''
                    };
                });
                displayPodium(topThreeWinners, allResults);
            }
        }

        function zoomToWinner(index) {
            if (index < 0 || index >= topThreeWinners.length) return;
            
            currentZoomIndex = index;
            showZoomedWinner(index);
        }

        function showZoomedWinner(index) {
            const winner = topThreeWinners[index];
            const folder = currentObjectConfig.folder;
            const objectName = currentObjectConfig.objectName;
            const rank = index === 0 ? '1st' : index === 1 ? '2nd' : '3rd';
            const borderClass = index === 0 ? 'zoom-gold' : index === 1 ? 'zoom-silver' : 'zoom-bronze';
            
            // Create or get overlay
            let overlay = document.querySelector('.zoom-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'zoom-overlay';
                document.body.appendChild(overlay);
            }
            
            overlay.innerHTML = `
                <div class="zoom-container ${borderClass}">
                    <div class="zoom-image">
                        <img src="${folder}/${winner.filename}" alt="${rank} place">
                    </div>
                    <div class="zoom-info">
                        <div class="zoom-badge">${rank}${showInitials ? ` <span class="zoom-initials ${borderClass === 'zoom-gold' ? 'zoom-initials-gold' : borderClass === 'zoom-silver' ? 'zoom-initials-silver' : 'zoom-initials-bronze'}">${getStudentName(objectName, winner.initials)}</span>` : ''}</div>
                        <div class="zoom-number">${winner.filenameNumber}</div>
                        <div class="zoom-points">${winner.points} points</div>
                    </div>
                    <div class="zoom-help">Use ← → arrow keys to navigate • Press Escape to close</div>
                </div>
            `;
            
            overlay.classList.add('active');
        }

        function closeZoom() {
            const overlay = document.querySelector('.zoom-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                setTimeout(() => {
                    overlay.innerHTML = '';
                }, 200);
            }
            currentZoomIndex = -1;
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const overlay = document.querySelector('.zoom-overlay');
            if (!overlay || !overlay.classList.contains('active')) return;
            
            switch(e.key) {
                case 'Escape':
                    e.preventDefault();
                    closeZoom();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (currentZoomIndex > 0) {
                        currentZoomIndex--;
                        showZoomedWinner(currentZoomIndex);
                    }
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if (currentZoomIndex < topThreeWinners.length - 1) {
                        currentZoomIndex++;
                        showZoomedWinner(currentZoomIndex);
                    }
                    break;
            }
        });

        // Initial load
        window.addEventListener('load', () => onObjectChange());
    </script>
</body>
</html>
